package example

//Utility Imports
import java.util.Calendar
import java.util.Timer
import java.net.UnknownHostException

//API imports
import org.apache.http.HttpEntity
import org.apache.http.HttpResponse
import org.apache.http.client.ClientProtocolException
import org.apache.http.client.HttpClient
import org.apache.http.client.methods.HttpGet
import org.apache.http.impl.client.DefaultHttpClient


//Kafka Imports
import java.util.Properties
import org.apache.kafka.clients.producer.{KafkaProducer, ProducerRecord}
import java.util.TimerTask



class ProducerClass {

  def apiRequestFunction(url: String): String = {
    val httpClient = new DefaultHttpClient() //Creates client object
    val httpResponse = httpClient.execute(new HttpGet(url)) //executes get url from the string that's passed
    val entity = httpResponse.getEntity() //'The stream comes in as an entity'
    var content = ""
    if (entity != null) { //If it's not null...
      val inputStream = entity.getContent() //...extract the content
      content = scala.io.Source.fromInputStream(inputStream).getLines.mkString //and convert that into a proper string
      inputStream.close
    }//End of '(entity != null)'
    httpClient.getConnectionManager().shutdown()
    return content
  }//End of apiRequestFunction()

  
    val coorArray = Array(
      (48.4529,-122.5556),
      (48.4529,-121.2369),
      (48.4529,-119.9182),
      (48.4529,-118.5995),
      (48.4529,-117.2808),
      (48.4529,-115.9621),
      (48.4529,-114.6434),
      (48.4529,-113.3247),
      (48.4529,-112.006),
      (48.4529,-110.6873),
      (48.4529,-109.3686),
      (48.4529,-108.0499),
      (48.4529,-106.7312),
      (48.4529,-105.4125),
      (48.4529,-104.0938),
      (48.4529,-102.7751),
      (48.4529,-101.4564),
      (48.4529,-100.1377),
      (48.4529,-98.819),
      (48.4529,-97.5003),
      (48.4529,-96.1816),
      (48.4529,-94.8629),
      (48.4529,-93.5442),
      (48.4529,-92.225),
      (47.4094,-122.5556),
      (47.4094,-121.2369),
      (47.4094,-119.9182),
      (47.4094,-118.5995),
      (47.4094,-117.2808),
      (47.4094,-115.9621),
      (47.4094,-114.6434),
      (47.4094,-113.3247),
      (47.4094,-112.006),
      (47.4094,-110.6873),
      (47.4094,-109.3686),
      (47.4094,-108.0499),
      (47.4094,-106.7312),
      (47.4094,-105.4125),
      (47.4094,-104.0938),
      (47.4094,-102.7751),
      (47.4094,-101.4564),
      (47.4094,-100.1377),
      (47.4094,-98.819),
      (47.4094,-97.5003),
      (47.4094,-96.1816),
      (47.4094,-94.8629),
      (47.4094,-93.5442),
      (47.4094,-92.2255),
      (46.3659,-122.5556),
      (46.3659,-121.2369),
      (46.3659,-119.9182),
      (46.3659,-118.5995),
      (46.3659,-117.2808),
      (46.3659,-115.9621),
      (46.3659,-114.6434),
      (46.3659,-113.3247),
      (46.3659,-112.006),
      (46.3659,-110.6873),
      (46.3659,-109.3686),
      (46.3659,-108.0499),
      (46.3659,-106.7312),
      (46.3659,-105.4125),
      (46.3659,-104.0938),
      (46.3659,-102.7751),
      (46.3659,-101.4564),
      (46.3659,-100.1377),
      (46.3659,-98.819),
      (46.3659,-97.5003),
      (46.3659,-96.1816),
      (46.3659,-94.8629),
      (46.3659,-93.5442),
      (46.3659,-92.2255),
      (46.3659,-90.9068),
      (46.3659,-89.5881),
      (46.3659,-88.2694),
      (46.3659,-86.9507),
      (46.3659,-85.632),
      (46.3659,-84.3133),
      (45.3224,-122.5556),
      (45.3224,-121.2369),
      (45.3224,-119.9182),
      (45.3224,-118.5995),
      (45.3224,-117.2808),
      (45.3224,-115.9621),
      (45.3224,-114.6434),
      (45.3224,-113.3247),
      (45.3224,-112.006),
      (45.3224,-110.6873),
      (45.3224,-109.3686),
      (45.3224,-108.0499),
      (45.3224,-106.7312),
      (45.3224,-105.4125),
      (45.3224,-104.0938),
      (45.3224,-102.7751),
      (45.3224,-101.4564),
      (45.3224,-100.1377),
      (45.3224,-98.819),
      (45.3224,-97.5003),
      (45.3224,-96.1816),
      (45.3224,-94.8629),
      (45.3224,-93.5442),
      (45.3224,-92.2255),
      (45.3224,-90.9068),
      (45.3224,-89.5881),
      (45.3224,-88.2694),
      (45.3224,-86.9507),
      (45.3224,-85.632),
      (45.3224,-84.3133),
      (45.3224,-82.9946),
      (45.3224,-70.4996),
      (45.3224,-69.1809),
      (45.3224,-67.8622),
      (45.3224,-66.5435),
      (44.2789,-122.5556),
      (44.2789,-121.2369),
      (44.2789,-119.9182),
      (44.2789,-118.5995),
      (44.2789,-117.2808),
      (44.2789,-115.9621),
      (44.2789,-114.6434),
      (44.2789,-113.3247),
      (44.2789,-112.006),
      (44.2789,-110.6873),
      (44.2789,-109.3686),
      (44.2789,-108.0499),
      (44.2789,-106.7312),
      (44.2789,-105.4125),
      (44.2789,-104.0938),
      (44.2789,-102.7751),
      (44.2789,-101.4564),
      (44.2789,-100.1377),
      (44.2789,-98.819),
      (44.2789,-97.5003),
      (44.2789,-96.1816),
      (44.2789,-94.8629),
      (44.2789,-93.5442),
      (44.2789,-92.2255),
      (44.2789,-90.9068),
      (44.2789,-89.5881),
      (44.2789,-88.2694),
      (44.2789,-86.9507),
      (44.2789,-85.632),
      (44.2789,-84.3133),
      (44.2789,-82.9946),
      (44.2789,-75.5509),
      (44.2789,-74.2322),
      (44.2789,-72.9135),
      (44.2789,-71.5948),
      (44.2789,-70.2761),
      (43.2354,-122.5556),
      (43.2354,-121.2369),
      (43.2354,-119.9182),
      (43.2354,-118.5995),
      (43.2354,-117.2808),
      (43.2354,-115.9621),
      (43.2354,-114.6434),
      (43.2354,-113.3247),
      (43.2354,-112.006),
      (43.2354,-110.6873),
      (43.2354,-109.3686),
      (43.2354,-108.0499),
      (43.2354,-106.7312),
      (43.2354,-105.4125),
      (43.2354,-104.0938),
      (43.2354,-102.7751),
      (43.2354,-101.4564),
      (43.2354,-100.1377),
      (43.2354,-98.819),
      (43.2354,-97.5003),
      (43.2354,-96.1816),
      (43.2354,-94.8629),
      (43.2354,-93.5442),
      (43.2354,-92.2255),
      (43.2354,-90.9068),
      (43.2354,-89.5881),
      (43.2354,-88.2694),
      (43.2354,-86.9507),
      (43.2354,-85.632),
      (43.2354,-84.3133),
      (43.2354,-82.9946),
      (43.2354,-78.7685),
      (43.2354,-77.4498),
      (43.2354,-76.1311),
      (43.2354,-74.8124),
      (43.2354,-73.4937),
      (43.2354,-72.175),
      (42.1919,-122.5556),
      (42.1919,-121.2369),
      (42.1919,-119.9182),
      (42.1919,-118.5995),
      (42.1919,-117.2808),
      (42.1919,-115.9621),
      (42.1919,-114.6434),
      (42.1919,-113.3247),
      (42.1919,-112.006),
      (42.1919,-110.6873),
      (42.1919,-109.3686),
      (42.1919,-108.0499),
      (42.1919,-106.7312),
      (42.1919,-105.4125),
      (42.1919,-104.0938),
      (42.1919,-102.7751),
      (42.1919,-101.4564),
      (42.1919,-100.1377),
      (42.1919,-98.819),
      (42.1919,-97.5003),
      (42.1919,-96.1816),
      (42.1919,-94.8629),
      (42.1919,-93.5442),
      (42.1919,-92.2255),
      (42.1919,-90.9068),
      (42.1919,-89.5881),
      (42.1919,-88.2694),
      (42.1919,-86.9507),
      (42.1919,-85.632),
      (42.1919,-84.3133),
      (42.1919,-82.9946),
      (42.1919,-79.7362),
      (42.1919,-78.4175),
      (42.1919,-77.0988),
      (42.1919,-75.7801),
      (42.1919,-74.4614),
      (42.1919,-73.1427),
      (41.1484,-122.5556),
      (41.1484,-121.2369),
      (41.1484,-119.9182),
      (41.1484,-118.5995),
      (41.1484,-117.2808),
      (41.1484,-115.9621),
      (41.1484,-114.6434),
      (41.1484,-113.3247),
      (41.1484,-112.006),
      (41.1484,-110.6873),
      (41.1484,-109.3686),
      (41.1484,-108.0499),
      (41.1484,-106.7312),
      (41.1484,-105.4125),
      (41.1484,-104.0938),
      (41.1484,-102.7751),
      (41.1484,-101.4564),
      (41.1484,-100.1377),
      (41.1484,-98.819),
      (41.1484,-97.5003),
      (41.1484,-96.1816),
      (41.1484,-94.8629),
      (41.1484,-93.5442),
      (41.1484,-92.2255),
      (41.1484,-90.9068),
      (41.1484,-89.5881),
      (41.1484,-88.2694),
      (41.1484,-86.9507),
      (41.1484,-85.632),
      (41.1484,-84.3133),
      (41.1484,-82.9946),
      (41.1484,-81.6759),
      (41.1484,-80.3572),
      (41.1484,-79.0385),
      (41.1484,-77.7198),
      (41.1484,-76.4011),
      (41.1484,-75.0824),
      (40.1049,-122.5556),
      (40.1049,-121.2369),
      (40.1049,-119.9182),
      (40.1049,-118.5995),
      (40.1049,-117.2808),
      (40.1049,-115.9621),
      (40.1049,-114.6434),
      (40.1049,-113.3247),
      (40.1049,-112.006),
      (40.1049,-110.6873),
      (40.1049,-109.3686),
      (40.1049,-108.0499),
      (40.1049,-106.7312),
      (40.1049,-105.4125),
      (40.1049,-104.0938),
      (40.1049,-102.7751),
      (40.1049,-101.4564),
      (40.1049,-100.1377),
      (40.1049,-98.819),
      (40.1049,-97.5003),
      (40.1049,-96.1816),
      (40.1049,-94.8629),
      (40.1049,-93.5442),
      (40.1049,-92.2255),
      (40.1049,-90.9068),
      (40.1049,-89.5881),
      (40.1049,-88.2694),
      (40.1049,-86.9507),
      (40.1049,-85.632),
      (40.1049,-84.3133),
      (40.1049,-82.9946),
      (40.1049,-81.6759),
      (40.1049,-80.3572),
      (40.1049,-79.0385),
      (40.1049,-77.7198),
      (40.1049,-76.4011),
      (40.1049,-75.0824),
      (39.0614,-122.5556),
      (39.0614,-121.2369),
      (39.0614,-119.9182),
      (39.0614,-118.5995),
      (39.0614,-117.2808),
      (39.0614,-115.9621),
      (39.0614,-114.6434),
      (39.0614,-113.3247),
      (39.0614,-112.006),
      (39.0614,-110.6873),
      (39.0614,-109.3686),
      (39.0614,-108.0499),
      (39.0614,-106.7312),
      (39.0614,-105.4125),
      (39.0614,-104.0938),
      (39.0614,-102.7751),
      (39.0614,-101.4564),
      (39.0614,-100.1377),
      (39.0614,-98.819),
      (39.0614,-97.5003),
      (39.0614,-96.1816),
      (39.0614,-94.8629),
      (39.0614,-93.5442),
      (39.0614,-92.2255),
      (39.0614,-90.9068),
      (39.0614,-89.5881),
      (39.0614,-88.2694),
      (39.0614,-86.9507),
      (39.0614,-85.632),
      (39.0614,-84.3133),
      (39.0614,-82.9946),
      (39.0614,-81.6759),
      (39.0614,-80.3572),
      (39.0614,-79.0385),
      (39.0614,-77.7198),
      (39.0614,-76.4011),
      (38.0179,-122.1852),
      (38.0179,-120.8665),
      (38.0179,-119.5478),
      (38.0179,-118.2291),
      (38.0179,-116.9104),
      (38.0179,-115.5917),
      (38.0179,-114.273),
      (38.0179,-112.9543),
      (38.0179,-111.6356),
      (38.0179,-110.3169),
      (38.0179,-108.9982),
      (38.0179,-107.6795),
      (38.0179,-106.3608),
      (38.0179,-105.0421),
      (38.0179,-103.7234),
      (38.0179,-102.4047),
      (38.0179,-101.086),
      (38.0179,-99.7673),
      (38.0179,-98.4486),
      (38.0179,-97.1299),
      (38.0179,-95.8112),
      (38.0179,-94.4925),
      (38.0179,-93.1738),
      (38.0179,-91.8551),
      (38.0179,-90.5364),
      (38.0179,-89.2177),
      (38.0179,-87.899),
      (38.0179,-86.5803),
      (38.0179,-85.2616),
      (38.0179,-83.9429),
      (38.0179,-82.6242),
      (38.0179,-81.3055),
      (38.0179,-79.9868),
      (38.0179,-78.6681),
      (38.0179,-77.3494),
      (38.0179,-76.0307),
      (36.9744,-121.2784),
      (36.9744,-119.9597),
      (36.9744,-118.641),
      (36.9744,-117.3223),
      (36.9744,-116.0036),
      (36.9744,-114.6849),
      (36.9744,-113.3662),
      (36.9744,-112.0475),
      (36.9744,-110.7288),
      (36.9744,-109.4101),
      (36.9744,-108.0914),
      (36.9744,-106.7727),
      (36.9744,-105.454),
      (36.9744,-104.1353),
      (36.9744,-102.8166),
      (36.9744,-101.4979),
      (36.9744,-100.1792),
      (36.9744,-98.8605),
      (36.9744,-97.5418),
      (36.9744,-96.2231),
      (36.9744,-94.9044),
      (36.9744,-93.5857),
      (36.9744,-92.267),
      (36.9744,-90.9483),
      (36.9744,-89.6296),
      (36.9744,-88.3109),
      (36.9744,-86.9922),
      (36.9744,-85.6735),
      (36.9744,-84.3548),
      (36.9744,-83.0361),
      (36.9744,-81.7174),
      (36.9744,-80.3987),
      (36.9744,-79.08),
      (36.9744,-77.7613),
      (36.9744,-76.4426),
      (35.9309,-121.0228),
      (35.9309,-119.7041),
      (35.9309,-118.3854),
      (35.9309,-117.0667),
      (35.9309,-115.748),
      (35.9309,-114.4293),
      (35.9309,-113.1106),
      (35.9309,-111.7919),
      (35.9309,-110.4732),
      (35.9309,-109.1545),
      (35.9309,-107.8358),
      (35.9309,-106.5171),
      (35.9309,-105.1984),
      (35.9309,-103.8797),
      (35.9309,-102.561),
      (35.9309,-101.2423),
      (35.9309,-99.9236),
      (35.9309,-98.6049),
      (35.9309,-97.2862),
      (35.9309,-95.9675),
      (35.9309,-94.6488),
      (35.9309,-93.3301),
      (35.9309,-92.0114),
      (35.9309,-90.6927),
      (35.9309,-89.374),
      (35.9309,-88.0553),
      (35.9309,-86.7366),
      (35.9309,-85.4179),
      (35.9309,-84.0992),
      (35.9309,-82.7805),
      (35.9309,-81.4618),
      (35.9309,-80.1431),
      (35.9309,-78.8244),
      (35.9309,-77.5057),
      (34.8874,-119.5924),
      (34.8874,-118.2737),
      (34.8874,-116.955),
      (34.8874,-115.6363),
      (34.8874,-114.3176),
      (34.8874,-112.9989),
      (34.8874,-111.6802),
      (34.8874,-110.3615),
      (34.8874,-109.0428),
      (34.8874,-107.7241),
      (34.8874,-106.4054),
      (34.8874,-105.0867),
      (34.8874,-103.768),
      (34.8874,-102.4493),
      (34.8874,-101.1306),
      (34.8874,-99.8119),
      (34.8874,-98.4932),
      (34.8874,-97.1745),
      (34.8874,-95.8558),
      (34.8874,-94.5371),
      (34.8874,-93.2184),
      (34.8874,-91.8997),
      (34.8874,-90.581),
      (34.8874,-89.2623),
      (34.8874,-87.9436),
      (34.8874,-86.6249),
      (34.8874,-85.3062),
      (34.8874,-83.9875),
      (34.8874,-82.6688),
      (34.8874,-81.3501),
      (34.8874,-80.0314),
      (34.8874,-78.7127),
      (33.8439,-117.1463),
      (33.8439,-115.8276),
      (33.8439,-114.5089),
      (33.8439,-113.1902),
      (33.8439,-111.8715),
      (33.8439,-110.5528),
      (33.8439,-109.2341),
      (33.8439,-107.9154),
      (33.8439,-106.5967),
      (33.8439,-105.278),
      (33.8439,-103.9593),
      (33.8439,-102.6406),
      (33.8439,-101.3219),
      (33.8439,-100.0032),
      (33.8439,-98.6845),
      (33.8439,-97.3658),
      (33.8439,-96.0471),
      (33.8439,-94.7284),
      (33.8439,-93.4097),
      (33.8439,-92.091),
      (33.8439,-90.7723),
      (33.8439,-89.4536),
      (33.8439,-88.1349),
      (33.8439,-86.8162),
      (33.8439,-85.4975),
      (33.8439,-84.1788),
      (33.8439,-82.8601),
      (33.8439,-81.5414),
      (33.8439,-80.2227),
      (32.8004,-117.1463),
      (32.8004,-115.8276),
      (32.8004,-114.5089),
      (32.8004,-113.1902),
      (32.8004,-111.8715),
      (32.8004,-110.5528),
      (32.8004,-109.2341),
      (32.8004,-107.9154),
      (32.8004,-106.5967),
      (32.8004,-105.278),
      (32.8004,-103.9593),
      (32.8004,-102.6406),
      (32.8004,-101.3219),
      (32.8004,-100.0032),
      (32.8004,-98.6845),
      (32.8004,-97.3658),
      (32.8004,-96.0471),
      (32.8004,-94.7284),
      (32.8004,-93.4097),
      (32.8004,-92.091),
      (32.8004,-90.7723),
      (32.8004,-89.4536),
      (32.8004,-88.1349),
      (32.8004,-86.8162),
      (32.8004,-85.4975),
      (32.8004,-84.1788),
      (32.8004,-82.8601),
      (32.8004,-81.5414),
      (31.7569,-111.0678),
      (31.7569,-109.7491),
      (31.7569,-108.4304),
      (31.7569,-107.1117),
      (31.7569,-105.793),
      (31.7569,-104.4743),
      (31.7569,-103.1556),
      (31.7569,-101.8369),
      (31.7569,-100.5182),
      (31.7569,-99.1995),
      (31.7569,-97.8808),
      (31.7569,-96.5621),
      (31.7569,-95.2434),
      (31.7569,-93.9247),
      (31.7569,-92.606),
      (31.7569,-91.2873),
      (31.7569,-89.9686),
      (31.7569,-88.6499),
      (31.7569,-87.3312),
      (31.7569,-86.0125),
      (31.7569,-84.6938),
      (31.7569,-83.3751),
      (31.7569,-82.0564),
      (31.7569,-80.7377),
      (30.7134,-105.039),
      (30.7134,-103.7203),
      (30.7134,-102.4016),
      (30.7134,-101.0829),
      (30.7134,-99.7642),
      (30.7134,-98.4455),
      (30.7134,-97.1268),
      (30.7134,-95.8081),
      (30.7134,-94.4894),
      (30.7134,-93.1707),
      (30.7134,-91.852),
      (30.7134,-90.5333),
      (30.7134,-89.2146),
      (30.7134,-87.8959),
      (30.7134,-86.5772),
      (30.7134,-85.2585),
      (30.7134,-83.9398),
      (30.7134,-82.6211),
      (30.7134,-81.3024),
      (29.6699,-104.1615),
      (29.6699,-102.8428),
      (29.6699,-101.5241),
      (29.6699,-100.2054),
      (29.6699,-98.8867),
      (29.6699,-97.568),
      (29.6699,-96.2493),
      (29.6699,-94.9306),
      (29.6699,-83.2205),
      (29.6699,-81.9018),
      (29.6699,-80.5831),
      (28.6264,-100.1678),
      (28.6264,-98.8491),
      (28.6264,-97.5304),
      (28.6264,-96.2117),
      (28.6264,-82.4508),
      (28.6264,-81.1321),
      (28.6264,-79.8134),
      (27.5829,-99.1141),
      (27.5829,-97.7954),
      (27.5829,-96.4767),
      (27.5829,-82.3799),
      (27.5829,-81.0612),
      (27.5829,-79.7425),
      (26.5394,-98.9755),
      (26.5394,-97.6568),
      (26.5394,-96.3381),
      (26.5394,-81.7153),
      (26.5394,-80.3966),
      (26.5394,-79.0779)
)

    

    def produce(){
      
      var lat: Double = 0
      var lon: Double = 0
      var index = 0
      var cycle = 0

      val props: Properties = new Properties()
      //props.put("bootstrap.servers","localhost:9092")
      props.put("bootstrap.servers", "sandbox-hdp.hortonworks.com:6667")
      props.put(
        "key.serializer",
        "org.apache.kafka.common.serialization.StringSerializer"
      )
      props.put(
        "value.serializer",
        "org.apache.kafka.common.serialization.StringSerializer"
      )
      // The acks config controls the criteria under which requests are considered complete.
      // The "all" setting we have specified will result in blocking on the full commit of the record,
      // the slowest but most durable setting.
      props.put("acks", "all")

      
      val producer = new KafkaProducer[String, String](props)      
      val topic = "OpenWeather_OneCall"

      val task = new TimerTask{       
          def run() = {
            //val startTime = System.currentTimeMillis()
            
          
            lat = coorArray(index)._1
            lon = coorArray(index)._2
            index = index+1

            val key = Calendar.getInstance().getTime().toString()
            var value = apiRequestFunction("http://api.openweathermap.org/data/2.5/weather?lat="+lat+"&lon="+lon+"&units=imperial&appid=39858c57bc812d47433632baf70aa20c")
            //var value = index.toString
            var record = new ProducerRecord[String,String](
              topic,
              key,
              value
              
            )
            producer.send(record)
            
            if (index == 599){
              cycle = cycle+1
              println("Cycle:"+cycle)
              index = 0
            }//End of 'if (index == 599)'

          }//End of run()
          run
        }//End of TimerTask

      try {
        
        println("Cycle:"+ cycle)

        val scheduler = new Timer
        scheduler.schedule(task,0L,2500L)
      } catch {
        case e: UnknownHostException => {
          e.printStackTrace() 
          task.run()
        }                       //Write these to error logs at some point
        case e: Throwable =>{
          e.printStackTrace()
          task.run()
        }
      } 

    }//End of Produce
  
 
}//End of Class